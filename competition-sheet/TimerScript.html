<script>
// TODO: 何番目スタートかを表示
function startTimer() {
  window.startTime = performance.now()
  window.running = true
  window.intervalId = window.setInterval(updateTimer, 10)
  document.getElementById("startButton").disabled = true
}
function resetTimer() {
  window.clearInterval(window.intervalId)
  window.startTime = null
  window.running = false
  for (var i = 0; i < 8; i++) {
    setPlayerTime(i, window.initialTimes[i])
  }
  document.getElementById("startButton").disabled = false
}

function formatTime(ms) {
  var min = Math.floor(ms / 60000)
  var sec = Math.floor(ms / 1000) % 60
  var cent = Math.floor(ms / 10) % 100
  
  return min + ":" + String(sec).padStart(2, "0") + "." + String(cent).padStart(2, "0")
}

function updateData() {
  if (window.running) return
  
  google.script.run.withSuccessHandler(function (result) {
    var parent = document.getElementById("timer")
    for (var i = 0; i < 8; i++) {
      var data = result[i]
      var player = parent.children[i]
      player.children[1].innerText = data.name
      setPlayerTime(i, data.time)
      initialTimes[i] = data.time
    }
  }).getTimerData()
}

function updateTimer() {
  var now = performance.now()
  var elapsed = now - window.startTime
  var parent = document.getElementById("timer")
  for (var i = 0; i < 8; i++) {
    var time = Math.max(0, window.initialTimes[i] - elapsed)
    setPlayerTime(i, time)
  }
}

function setPlayerTime(index, time) {
  var e = document.getElementById("timer").children[index]
  e.children[2].innerText = formatTime(time)
  e.children[3].style.width = (time / 200) + "px"
  var color = "#35a16b"
  if (time < 10000) color = "#faf500"
  if (time < 5000) {
    var t = (1000 - (time % 1000)) / 1000
    var u = Math.sqrt(t)
    color = tinycolor.mix("#ff2800", "#faf500", u * 100).toRgbString();
  }
  e.children[3].style.background = color
}

window.running = false
window.startTime = null
window.intervalId = null
window.initialTimes = new Array(8)

window.setInterval(updateData, 10000)
updateData()

</script>
